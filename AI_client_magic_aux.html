<script>
  // Vari√°veis globais
  let selectedPrompts = [];
  let selectedH1sWithEligibleH2s = [];
  let processingQueue = [];
  let progressInterval;
  let currentProgress = 0;
  let totalPairs = 0;
  
  document.addEventListener('DOMContentLoaded', function() {
    // Carrega os dados que j√° est√£o dispon√≠veis via scriplet
    initializeModal();
    
    // Event listeners para os containers
    document.getElementById('promptsContainer').addEventListener('click', handlePromptClick);
    document.getElementById('pairsContainer').addEventListener('click', handlePairClick);
  });

  window.addEventListener('beforeunload', function() {
    stopProgressSimulation();
  });

  /**
   * Inicializa o modal com os dados j√° carregados
   */
  function initializeModal() {
    console.log('üöÄ Inicializando modal com dados pr√©-carregados');
    
    // Os dados j√° est√£o dispon√≠veis nas vari√°veis globais via scriplet
    if (promptsArray && promptsArray.length > 0) {
      console.log('‚úÖ Prompts dispon√≠veis:', promptsArray.length);
      renderPrompts();
    } else {
      console.error('‚ùå Nenhum prompt dispon√≠vel');
      document.getElementById('promptsContainer').innerHTML = 
        '<div class="text-center p-3"><p class="text-danger">Nenhum prompt dispon√≠vel</p></div>';
    }
    
    if (uniqueHeadline1s && uniqueHeadline1s.length > 0) {
      console.log('‚úÖ H1s com H2s eleg√≠veis dispon√≠veis:', uniqueHeadline1s.length);
      renderH1sWithEligibleH2s();
    } else {
      console.error('‚ùå Nenhum H1 com H2s eleg√≠veis dispon√≠vel');
      document.getElementById('pairsContainer').innerHTML = 
        '<div class="text-center p-3"><p class="text-danger">Nenhum paciente com H2s eleg√≠veis dispon√≠vel</p></div>';
    }
  }

  function renderPrompts() {
    const container = document.getElementById('promptsContainer');
    
    if (!promptsArray || promptsArray.length === 0) {
      container.innerHTML = '<div class="text-center p-3"><p class="text-muted">Nenhum prompt dispon√≠vel.</p></div>';
      return;
    }

    // Criar array com √≠ndices e prompts para manter refer√™ncia aos √≠ndices originais
    const promptsWithIndex = promptsArray.map((prompt, index) => ({
      ...prompt,
      originalIndex: index
    }));

    // Ordenar alfabeticamente pelo optionText (prompt-title)
    const sortedPrompts = promptsWithIndex.sort((a, b) => 
      a.optionText.localeCompare(b.optionText, 'pt-BR', { sensitivity: 'base' })
    );

    container.innerHTML = sortedPrompts.map((prompt, displayIndex) => `
      <div class="prompt-option p-2 ${selectedPrompts.includes(prompt.originalIndex) ? 'selected' : ''}" data-index="${prompt.originalIndex}">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" 
                 id="prompt${prompt.originalIndex}" value="${prompt.originalIndex}"
                 ${selectedPrompts.includes(prompt.originalIndex) ? 'checked' : ''}>
          <label class="form-check-label" for="prompt${prompt.originalIndex}">
            <div class="prompt-title">${prompt.optionText}</div>
            <div class="prompt-description">${prompt.fromHeadline2} ‚Üí ${prompt.toHeadline2}</div>
          </label>
        </div>
      </div>
    `).join('');
    
    updateConfirmButton();
  }

  function renderH1sWithEligibleH2s() {
    const container = document.getElementById('pairsContainer');
    const noPairsDiv = document.getElementById('noPairsMessage');
    const selectAllBtn = document.getElementById('selectAllPatientsBtn');
    
    if (!uniqueHeadline1s || uniqueHeadline1s.length === 0) {
      container.style.display = 'none';
      noPairsDiv.style.display = 'block';
      selectAllBtn.style.display = 'none';
      noPairsDiv.innerHTML = `
        <h6>Nenhum paciente com H2s eleg√≠veis encontrado</h6>
        <p class="small">Nenhum paciente possui H2s compat√≠veis com os prompts dispon√≠veis.</p>
      `;
      return;
    }

    container.style.display = 'block';
    noPairsDiv.style.display = 'none';
    
    // L√≥gica de pr√©-sele√ß√£o: se tiver apenas 1 item, j√° vem pr√©-selecionado
    if (uniqueHeadline1s.length === 1 && selectedH1sWithEligibleH2s.length === 0) {
      selectedH1sWithEligibleH2s = [0];
      selectAllBtn.style.display = 'none';
    } else if (uniqueHeadline1s.length > 1) {
      selectAllBtn.style.display = 'block';
    } else {
      selectAllBtn.style.display = 'none';
    }
    
    container.innerHTML = uniqueHeadline1s.map((h1Item, index) => `
      <div class="pair-option p-2 ${selectedH1sWithEligibleH2s.includes(index) ? 'selected' : ''}" data-index="${index}">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" 
                 id="headline1_${index}" value="${index}"
                 ${selectedH1sWithEligibleH2s.includes(index) ? 'checked' : ''}>
          <label class="form-check-label" for="headline1_${index}">
            <div class="headline1">${h1Item.headline1}</div>
            <div class="content-preview small text-muted mt-1">
              H2s eleg√≠veis: ${h1Item.eligibleH2s.join(', ')}
            </div>
          </label>
        </div>
      </div>
    `).join('');
    
    // Atualizar o estado do bot√£o "Selecionar todos"
    updateSelectAllButton();
    
    updateConfirmButton();
  }

  function selectAllPatients() {
    if (!uniqueHeadline1s || uniqueHeadline1s.length === 0) {
      return;
    }
    
    // Selecionar todos os pacientes
    selectedH1sWithEligibleH2s = uniqueHeadline1s.map((_, index) => index);
    
    // Atualizar visualmente todos os checkboxes
    const container = document.getElementById('pairsContainer');
    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
    const pairOptions = container.querySelectorAll('.pair-option');
    
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
    
    pairOptions.forEach(option => {
      option.classList.add('selected');
    });
    
    // Atualizar o bot√£o de confirma√ß√£o
    updateConfirmButton();
    
    // Trocar o texto do bot√£o para "Desmarcar todos"
    const selectAllBtn = document.getElementById('selectAllPatientsBtn');
    selectAllBtn.textContent = 'Desmarcar todos';
    selectAllBtn.onclick = () => deselectAllPatients();
  }

  function deselectAllPatients() {
    // Desmarcar todos os pacientes
    selectedH1sWithEligibleH2s = [];
    
    // Atualizar visualmente todos os checkboxes
    const container = document.getElementById('pairsContainer');
    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
    const pairOptions = container.querySelectorAll('.pair-option');
    
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
    
    pairOptions.forEach(option => {
      option.classList.remove('selected');
    });
    
    // Atualizar o bot√£o de confirma√ß√£o
    updateConfirmButton();
    
    // Trocar o texto do bot√£o para "Selecionar todos"
    const selectAllBtn = document.getElementById('selectAllPatientsBtn');
    selectAllBtn.textContent = 'Selecionar todos';
    selectAllBtn.onclick = () => selectAllPatients();
  }

  function updateSelectAllButton() {
    const selectAllBtn = document.getElementById('selectAllPatientsBtn');
    if (!uniqueHeadline1s || uniqueHeadline1s.length <= 1) {
      selectAllBtn.style.display = 'none';
      return;
    }
    
    selectAllBtn.style.display = 'block';
    
    // Se todos est√£o selecionados, mostrar "Desmarcar todos"
    if (selectedH1sWithEligibleH2s.length === uniqueHeadline1s.length) {
      selectAllBtn.textContent = 'Desmarcar todos';
      selectAllBtn.onclick = () => deselectAllPatients();
    } else {
      selectAllBtn.textContent = 'Selecionar todos';
      selectAllBtn.onclick = () => selectAllPatients();
    }
  }
  
  function handlePromptClick(event) {
    const promptOption = event.target.closest('.prompt-option');
    if (!promptOption) return;

    setTimeout(() => {
      const checkbox = promptOption.querySelector('input[type="checkbox"]');
      if (!checkbox) return;
      
      const index = parseInt(promptOption.dataset.index, 10);
      const isChecked = checkbox.checked;

      if (isChecked) {
        if (!selectedPrompts.includes(index)) {
          selectedPrompts.push(index);
        }
        promptOption.classList.add('selected');
      } else {
        selectedPrompts = selectedPrompts.filter(i => i !== index);
        promptOption.classList.remove('selected');
      }
      
      updateConfirmButton();
    }, 0);
  }

  function handlePairClick(event) {
    const pairOption = event.target.closest('.pair-option');
    if (!pairOption) return;

    setTimeout(() => {
      const checkbox = pairOption.querySelector('input[type="checkbox"]');
      if (!checkbox) return;
      
      const index = parseInt(pairOption.dataset.index, 10);
      const isChecked = checkbox.checked;

      if (isChecked) {
        if (!selectedH1sWithEligibleH2s.includes(index)) {
          selectedH1sWithEligibleH2s.push(index);
        }
        pairOption.classList.add('selected');
      } else {
        selectedH1sWithEligibleH2s = selectedH1sWithEligibleH2s.filter(i => i !== index);
        pairOption.classList.remove('selected');
      }
      
      // Atualizar o estado do bot√£o "Selecionar todos"
      updateSelectAllButton();
      
      updateConfirmButton();
    }, 0);
  }

  function updateConfirmButton() {
    const confirmBtn = document.getElementById('confirmBtn');
    const hasPrompts = selectedPrompts.length > 0;
    const hasH1s = selectedH1sWithEligibleH2s.length > 0;
    
    confirmBtn.disabled = !hasPrompts || !hasH1s;
    
    if (hasPrompts && hasH1s) {
      confirmBtn.textContent = `Processar (${selectedPrompts.length} prompts, ${selectedH1sWithEligibleH2s.length} pacientes)`;
    } else if (!hasPrompts && !hasH1s) {
      confirmBtn.textContent = 'Processar';
    } else if (!hasPrompts) {
      confirmBtn.textContent = 'Processar (selecione prompts)';
    } else {
      confirmBtn.textContent = 'Processar (selecione pacientes)';
    }
  }

  function confirmSelection() {
    if (selectedPrompts.length === 0) {
      alert('‚ùå Por favor, selecione pelo menos um prompt.');
      return;
    }

    if (selectedH1sWithEligibleH2s.length === 0) {
      alert('‚ùå Por favor, selecione pelo menos um paciente.');
      return;
    }

    // Construir pilha de processamento
    processingQueue = buildProcessingQueue();
    
    if (processingQueue.length === 0) {
      alert('‚ùå Nenhum processamento v√°lido encontrado. Verifique se os prompts selecionados s√£o compat√≠veis com os H2s eleg√≠veis dos pacientes.');
      return;
    }

    // Executar processamento imediatamente
    executeProcessingQueue(processingQueue);
  }

  function buildProcessingQueue() {
    const queue = [];
    
    selectedH1sWithEligibleH2s.forEach(h1Index => {
      const h1Item = uniqueHeadline1s[h1Index];
      
      selectedPrompts.forEach(promptIndex => {
        const prompt = promptsArray[promptIndex];
        
        // Verificar se este H1 tem o fromH2 que o prompt precisa
        if (h1Item.eligibleH2s.includes(prompt.fromHeadline2)) {
          queue.push({
            headline1: h1Item.headline1,
            prompt: prompt,
            fromH2: prompt.fromHeadline2,
            toH2: prompt.toHeadline2
          });
        }
      });
    });
    
    return queue;
  }



  function executeProcessingQueue(queue) {
    // Preparar dados para o servidor no formato esperado
    const uniqueH1s = [...new Set(queue.map(item => item.headline1))];
    const uniquePrompts = [];
    const promptsSet = new Set();
    
    queue.forEach(item => {
      const promptKey = `${item.prompt.fromHeadline2}|${item.prompt.toHeadline2}`;
      if (!promptsSet.has(promptKey)) {
        promptsSet.add(promptKey);
        uniquePrompts.push(item.prompt);
      }
    });
    
    const processingData = {
      headline1s: uniqueH1s.map(h1 => ({ headline1: h1 })),
      prompts: uniquePrompts,
      requireAugmentedContext: document.getElementById('augmentedContextCheck').checked
    };

    console.log('Executando pilha de processamento:', processingData);

    totalPairs = queue.length; // Adicione esta linha

    showProgress();
    startProgressSimulation();

    google.script.run
      .withSuccessHandler(onSelectionConfirmed)
      .withFailureHandler(onSelectionError)
      .processSequentialPromptsForPairs(processingData);
  }

  function startProgressSimulation() {
    currentProgress = 0;
    updateProgress(0, 'Iniciando processamento...');
    const estimatedTimePerPair = 4000;
    const totalEstimatedTime = totalPairs * estimatedTimePerPair;
    const updateInterval = 200;
    const progressIncrement = (updateInterval / totalEstimatedTime) * 100;
    
    progressInterval = setInterval(() => {
      currentProgress += progressIncrement;
      if (currentProgress >= 95) {
        currentProgress = 95;
        clearInterval(progressInterval);
      }
      let status = 'Aplicando formata√ß√£o...';
      if (currentProgress < 20) status = 'Preparando dados...';
      else if (currentProgress < 40) status = 'Processando com IA...';
      else if (currentProgress < 60) status = 'Atualizando documento...';
      else if (currentProgress < 80) status = 'Finalizando processamento...';
      updateProgress(currentProgress, status);
    }, updateInterval);
  }

  function stopProgressSimulation() {
    if (progressInterval) {
      clearInterval(progressInterval);
      progressInterval = null;
    }
  }

  function showProgress() {
    document.querySelector('.two-columns').style.display = 'none';
    document.getElementById('progressContainer').style.display = 'block';
    const confirmBtn = document.getElementById('confirmBtn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Processando...';
  }

  function updateProgress(percentage, status) {
    const progressBar = document.getElementById('progressBar');
    const progressStatus = document.getElementById('progressStatus');
    progressBar.style.width = percentage + '%';
    progressBar.setAttribute('aria-valuenow', percentage);
    progressBar.textContent = Math.round(percentage) + '%';
    progressStatus.textContent = status;
  }

  function hideProgress() {
    stopProgressSimulation();
    document.getElementById('progressContainer').style.display = 'none';
    const confirmBtn = document.getElementById('confirmBtn');
    confirmBtn.disabled = false;
    confirmBtn.textContent = 'OK';
  }

  function onSelectionConfirmed(result) {
    console.log('Processamento conclu√≠do:', result);
    updateProgress(100, 'Processamento conclu√≠do!');
    setTimeout(() => {
      google.script.host.close();
    }, 1500);
  }

  function onSelectionError(error) {
    console.error('Erro no processamento:', error);
    hideProgress();
    alert('‚ùå Erro no processamento: ' + error.message);
  }

  function cancelSelection() {
    google.script.host.close();
  }
</script> 