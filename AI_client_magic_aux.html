<script>
  // Vari√°veis globais
  let selectedPrompts = {}; // Objeto para armazenar a a√ß√£o de cada prompt
  let selectedPatients = [];
  let processingQueue = [];
  let progressInterval;
  let currentProgress = 0;
  let totalPairs = 0;
  
  document.addEventListener('DOMContentLoaded', function() {
    initializeModal();
    document.getElementById('promptsContainer').addEventListener('change', handlePromptChange);
    document.getElementById('pairsContainer').addEventListener('click', handlePatientClick);
  });

  window.addEventListener('beforeunload', function() {
    stopProgressSimulation();
  });

  function initializeModal() {
    console.log('üöÄ Inicializando modal com dados pr√©-carregados');
    if (promptsArray && promptsArray.length > 0) {
      renderPrompts();
    } else {
      document.getElementById('promptsContainer').innerHTML = 
        '<div class="text-center p-3"><p class="text-danger">Nenhum prompt dispon√≠vel</p></div>';
    }
    if (uniqueHeadline1s && uniqueHeadline1s.length > 0) {
      renderPatients();
    } else {
      document.getElementById('pairsContainer').innerHTML = 
        '<div class="text-center p-3"><p class="text-danger">Nenhum paciente dispon√≠vel</p></div>';
    }
  }

  function renderPrompts() {
    const container = document.getElementById('promptsContainer');
    if (!promptsArray || promptsArray.length === 0) {
      container.innerHTML = '<div class="text-center p-3"><p class="text-muted">Nenhum prompt dispon√≠vel.</p></div>';
      return;
    }
    const sortedPrompts = [...promptsArray].sort((a, b) => a.optionText.localeCompare(b.optionText, 'pt-BR'));
    container.innerHTML = sortedPrompts.map((prompt, index) => {
      const promptId = `prompt_${index}`;
      return `
      <div class="prompt-option p-2" data-prompt-title="${prompt.optionText}">
        <div class="prompt-title">${prompt.optionText}</div>
        <div class="prompt-description">${prompt.toHeadline2}</div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="action_${promptId}" value="correct_generate" data-prompt-title="${prompt.optionText}" checked>
          <label class="form-check-label">Corrigir/Gerar</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="action_${promptId}" value="add" data-prompt-title="${prompt.optionText}">
          <label class="form-check-label">Adicionar</label>
        </div>
      </div>
    `}).join('');
    // Initialize selectedPrompts with default action for all prompts
    promptsArray.forEach(prompt => {
        selectedPrompts[prompt.optionText] = 'correct_generate';
    });
    updateConfirmButton();
  }

  function renderPatients() {
    const container = document.getElementById('pairsContainer');
    const noPairsDiv = document.getElementById('noPairsMessage');
    const selectAllBtn = document.getElementById('selectAllPatientsBtn');
    
    if (!uniqueHeadline1s || uniqueHeadline1s.length === 0) {
      container.style.display = 'none';
      noPairsDiv.style.display = 'block';
      selectAllBtn.style.display = 'none';
      noPairsDiv.innerHTML = `<h6>Nenhum paciente encontrado</h6><p class="small">O documento n√£o possui pacientes (H1).</p>`;
      return;
    }

    container.style.display = 'block';
    noPairsDiv.style.display = 'none';
    
    if (uniqueHeadline1s.length > 1) {
      selectAllBtn.style.display = 'block';
    } else {
      selectAllBtn.style.display = 'none';
    }
    
    container.innerHTML = uniqueHeadline1s.map((patient, index) => `
      <div class="pair-option p-2 ${selectedPatients.includes(index) ? 'selected' : ''}" data-index="${index}">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="patient_${index}" value="${index}" ${selectedPatients.includes(index) ? 'checked' : ''}>
          <label class="form-check-label" for="patient_${index}">
            <div class="headline1">${patient.headline1}</div>
          </label>
        </div>
      </div>
    `).join('');
    
    updateSelectAllButton();
    updateConfirmButton();
  }

  function handlePromptChange(event) {
    const target = event.target;
    if (target.type === 'radio' && target.checked) {
        const promptTitle = target.dataset.promptTitle;
        selectedPrompts[promptTitle] = target.value;
        document.querySelectorAll(`div[data-prompt-title="${promptTitle}"]`).forEach(el => el.classList.add('selected'));
    }
    updateConfirmButton();
}

  function selectAllPatients() {
    selectedPatients = uniqueHeadline1s.map((_, index) => index);
    renderPatients();
  }

  function deselectAllPatients() {
    selectedPatients = [];
    renderPatients();
  }

  function updateSelectAllButton() {
    const selectAllBtn = document.getElementById('selectAllPatientsBtn');
    if (!uniqueHeadline1s || uniqueHeadline1s.length <= 1) {
      selectAllBtn.style.display = 'none';
      return;
    }
    selectAllBtn.style.display = 'block';
    if (selectedPatients.length === uniqueHeadline1s.length) {
      selectAllBtn.textContent = 'Desmarcar todos';
      selectAllBtn.onclick = deselectAllPatients;
    } else {
      selectAllBtn.textContent = 'Selecionar todos';
      selectAllBtn.onclick = selectAllPatients;
    }
  }
  
  function handlePatientClick(event) {
    const patientOption = event.target.closest('.pair-option');
    if (!patientOption) return;

    setTimeout(() => {
      const checkbox = patientOption.querySelector('input[type="checkbox"]');
      if (!checkbox) return;
      
      const index = parseInt(patientOption.dataset.index, 10);
      const isChecked = checkbox.checked;

      if (isChecked) {
        if (!selectedPatients.includes(index)) {
          selectedPatients.push(index);
        }
        patientOption.classList.add('selected');
      } else {
        selectedPatients = selectedPatients.filter(i => i !== index);
        patientOption.classList.remove('selected');
      }
      
      updateSelectAllButton();
      updateConfirmButton();
    }, 0);
  }

  function updateConfirmButton() {
    const confirmBtn = document.getElementById('confirmBtn');
    const hasPrompts = Object.keys(selectedPrompts).length > 0;
    const hasPatients = selectedPatients.length > 0;
    
    confirmBtn.disabled = !hasPrompts || !hasPatients;
    
    if (hasPrompts && hasPatients) {
      confirmBtn.textContent = `Processar (${Object.keys(selectedPrompts).length} prompts, ${selectedPatients.length} pacientes)`;
    } else {
      confirmBtn.textContent = 'Processar';
    }
  }

  function confirmSelection() {
    if (Object.keys(selectedPrompts).length === 0) {
      alert('‚ùå Por favor, selecione pelo menos um prompt.');
      return;
    }
    if (selectedPatients.length === 0) {
      alert('‚ùå Por favor, selecione pelo menos um paciente.');
      return;
    }
    processingQueue = buildProcessingQueue();
    if (processingQueue.length === 0) {
      alert('‚ùå Nenhum processamento v√°lido encontrado.');
      return;
    }
    executeProcessingQueue(processingQueue);
  }

  function buildProcessingQueue() {
    const queue = [];
    selectedPatients.forEach(patientIndex => {
      const patient = uniqueHeadline1s[patientIndex];
      promptsArray.forEach(prompt => {
          const action = selectedPrompts[prompt.optionText];
          if(action){
            queue.push({
                headline1: patient.headline1,
                prompt: prompt,
                action: action
            });
          }
      });
    });
    return queue;
  }

  function executeProcessingQueue(queue) {
    const promptsForServer = [];
    const promptActions = {};
    
    queue.forEach(item => {
        if (!promptActions[item.prompt.optionText]) {
            promptsForServer.push(item.prompt);
            promptActions[item.prompt.optionText] = item.action;
        }
    });

    const processingData = {
      headline1s: selectedPatients.map(i => uniqueHeadline1s[i]),
      prompts: promptsForServer.map(p => ({...p, action: promptActions[p.optionText]}))
    };

    console.log('Executando pilha de processamento:', processingData);
    totalPairs = queue.length;
    showProgress();
    startProgressSimulation();
    google.script.run
      .withSuccessHandler(onSelectionConfirmed)
      .withFailureHandler(onSelectionError)
      .processSequentialPromptsForPairs(processingData);
  }

  function startProgressSimulation() {
    currentProgress = 0;
    updateProgress(0, 'Iniciando processamento...');
    const estimatedTimePerPair = 4000;
    const totalEstimatedTime = totalPairs * estimatedTimePerPair;
    const updateInterval = 200;
    const progressIncrement = (updateInterval / totalEstimatedTime) * 100;
    
    progressInterval = setInterval(() => {
      currentProgress += progressIncrement;
      if (currentProgress >= 95) {
        currentProgress = 95;
        clearInterval(progressInterval);
      }
      let status = 'Aplicando formata√ß√£o...';
      if (currentProgress < 20) status = 'Preparando dados...';
      else if (currentProgress < 40) status = 'Processando com IA...';
      else if (currentProgress < 60) status = 'Atualizando documento...';
      else if (currentProgress < 80) status = 'Finalizando processamento...';
      updateProgress(currentProgress, status);
    }, updateInterval);
  }

  function stopProgressSimulation() {
    if (progressInterval) {
      clearInterval(progressInterval);
      progressInterval = null;
    }
  }

  function showProgress() {
    document.querySelector('.two-columns').style.display = 'none';
    document.getElementById('progressContainer').style.display = 'block';
    const confirmBtn = document.getElementById('confirmBtn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Processando...';
  }

  function updateProgress(percentage, status) {
    const progressBar = document.getElementById('progressBar');
    const progressStatus = document.getElementById('progressStatus');
    progressBar.style.width = percentage + '%';
    progressBar.setAttribute('aria-valuenow', percentage);
    progressBar.textContent = Math.round(percentage) + '%';
    progressStatus.textContent = status;
  }

  function hideProgress() {
    stopProgressSimulation();
    document.getElementById('progressContainer').style.display = 'none';
    const confirmBtn = document.getElementById('confirmBtn');
    confirmBtn.disabled = false;
    confirmBtn.textContent = 'OK';
  }

  function onSelectionConfirmed(result) {
    console.log('Processamento conclu√≠do:', result);
    updateProgress(100, 'Processamento conclu√≠do!');
    setTimeout(() => {
      google.script.host.close();
    }, 1500);
  }

  function onSelectionError(error) {
    console.error('Erro no processamento:', error);
    hideProgress();
    alert('‚ùå Erro no processamento: ' + error.message);
  }

  function cancelSelection() {
    google.script.host.close();
  }
</script> 