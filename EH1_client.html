<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: 'Roboto', Arial, sans-serif; margin: 20px; background-color: #f8f9fa; }
      #container { display: flex; flex-direction: column; height: 100%; }
      h3 { color: #202124; font-weight: 500;}
      p { color: #5f6368; }
      textarea { width: 95%; height: 200px; margin-bottom: 12px; border: 1px solid #dadce0; border-radius: 4px; padding: 8px; font-family: monospace; }
      textarea:focus { border-color: #1a73e8; outline: none; }
      #button-group { display: flex; gap: 10px; }
      button { padding: 10px 16px; border: none; background-color: #4285F4; color: white; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 14px;}
      button:hover { background-color: #357ae8; }
      button:disabled { background-color: #e0e0e0; cursor: not-allowed;}
      #status { margin-top: 20px; padding: 10px; font-family: monospace; background-color: #e8eaed; border-radius: 4px; min-height: 20px; }
    </style>
  </head>
  <body>
    <div id="container">
      <h3>Filtrar e Listar Pacientes</h3>
      <p>Cole o texto do relatório e escolha um filtro para listar os pacientes no documento.</p>
      <textarea id="inputText" placeholder="Seu texto de agendamentos aqui..."></textarea>
      
      <div id="button-group">
        <button onclick="runExtraction('toda')">Toda a Agenda</button>
        <button onclick="runExtraction('matutino')">Apenas Matutino</button>
        <button onclick="runExtraction('vespertino')">Apenas Vespertino</button>
      </div>
      
      <div id="status">Pronto para iniciar...</div>
    </div>
    
    <script>
      const statusDiv = document.getElementById('status');
      const buttons = document.querySelectorAll('button');

      function setUiState(isLoading, message) {
        statusDiv.innerText = message;
        buttons.forEach(btn => btn.disabled = isLoading);
      }

      function runExtraction(filterType) {
        const pastedText = document.getElementById('inputText').value;
        if (!pastedText.trim()) {
           setUiState(false, "Erro: A caixa de texto está vazia.");
           return;
        }

        setUiState(true, '1/3: Extraindo e ordenando dados...');
        
        google.script.run
          .withSuccessHandler(onExtractionSuccess)
          .withFailureHandler(onFailure)
          .processPastedText(pastedText, filterType);
      }
      
      function onExtractionSuccess(processedJsonString) {
        setUiState(true, '2/3: Dados processados. Escrevendo no documento...');
        
        google.script.run
          .withSuccessHandler(onWriteSuccess)
          .withFailureHandler(onFailure)
          .writeToDocument(processedJsonString);
      }

      function onWriteSuccess(finalMessage) {
        setUiState(false, `3/3: Concluído! ${finalMessage}`);
        // Opcional: fechar a caixa de diálogo após 2 segundos.
        // setTimeout(() => google.script.host.close(), 2000);
      }
      
      function onFailure(error) {
        setUiState(false, 'Ocorreu um erro:\n' + error.message);
      }
    </script>
  </body>
</html>